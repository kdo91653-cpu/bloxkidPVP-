local CamlockModule = {}
CamlockModule.Enabled = false
CamlockModule.Connections = {}
CamlockModule.CurrentTarget = nil
CamlockModule.UIVisible = true
CamlockModule.Keybinds = {
    Toggle = Enum.KeyCode.T,
    Switch = Enum.KeyCode.Y
}
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer
local function GetClosestPlayer()
    local target = nil
    local maxDot = -1
    local camera = workspace.CurrentCamera
    local cameraPos = camera.CFrame.Position
    local cameraLook = camera.CFrame.LookVector    
    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= player and p.Character then
            local humanoidRootPart = p.Character:FindFirstChild("HumanoidRootPart")
            local humanoid = p.Character:FindFirstChildOfClass("Humanoid")          
            if humanoidRootPart and humanoid and humanoid.Health > 0 then
                local direction = (humanoidRootPart.Position - cameraPos).Unit
                local dotProduct = cameraLook:Dot(direction)              
                if dotProduct > 0 and dotProduct > maxDot then
                    maxDot = dotProduct
                    target = p
                end
            end
        end
    end   
    return target
end
local function GetBodyPosition(character)
    if not character then return nil end   
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return nil end    
    local torso = character:FindFirstChild("Torso") or character:FindFirstChild("UpperTorso")   
    if torso then
        return torso.Position
    else
        return humanoidRootPart.Position + Vector3.new(0, 1.5, 0)
    end
end
local function GetNextTarget()
    if not CamlockModule.CurrentTarget then
        return GetClosestPlayer()
    end  
    local players = Players:GetPlayers()
    local currentIndex = 0    
    for i, p in ipairs(players) do
        if p == CamlockModule.CurrentTarget then
            currentIndex = i
            break
        end
    end    
    for i = 1, #players do
        local nextIndex = (currentIndex + i) % #players
        if nextIndex == 0 then nextIndex = #players end        
        local nextPlayer = players[nextIndex]        
        if nextPlayer ~= player and 
           nextPlayer.Character and 
           nextPlayer.Character:FindFirstChild("HumanoidRootPart") and
           nextPlayer ~= CamlockModule.CurrentTarget then            
            local humanoid = nextPlayer.Character:FindFirstChildOfClass("Humanoid")
            if humanoid and humanoid.Health > 0 then
                return nextPlayer
            end
        end
    end   
    return GetClosestPlayer()
end
local function UpdateCamlock()
    if not CamlockModule.Enabled or not CamlockModule.CurrentTarget then
        return
    end   
    local target = CamlockModule.CurrentTarget
    if not target.Character then
        CamlockModule.CurrentTarget = GetClosestPlayer()
        return
    end    
    local humanoidRootPart = target.Character:FindFirstChild("HumanoidRootPart")
    local humanoid = target.Character:FindFirstChildOfClass("Humanoid")  
    if humanoidRootPart and humanoid and humanoid.Health > 0 then
        local camera = workspace.CurrentCamera
        local cameraPos = camera.CFrame.Position
        local targetPos = GetBodyPosition(target.Character)       
        if targetPos then
            local lookVector = (targetPos - cameraPos).Unit
            camera.CFrame = CFrame.new(cameraPos, cameraPos + lookVector)
        end
    else
        CamlockModule.CurrentTarget = GetClosestPlayer()
    end
end
local function ToggleCamlock()
    if CamlockModule.Enabled then
        CamlockModule.Enabled = false
        CamlockModule.CurrentTarget = nil      
        if CamlockModule.UI and CamlockModule.UI:FindFirstChild("MainFrame") then
            local leftBtn = CamlockModule.UI.MainFrame:FindFirstChild("LeftBtn")
            if leftBtn then
                leftBtn.BackgroundColor3 = Color3.fromRGB(35,35,35)
                if leftBtn:FindFirstChild("UIStroke") then
                    leftBtn.UIStroke.Color = Color3.fromRGB(120,120,120)
                end
            end
        end      
        print("[Camlock] Disabled")
    else
        local target = GetClosestPlayer()
        if target then
            CamlockModule.Enabled = true
            CamlockModule.CurrentTarget = target            
            if CamlockModule.UI and CamlockModule.UI:FindFirstChild("MainFrame") then
                local leftBtn = CamlockModule.UI.MainFrame:FindFirstChild("LeftBtn")
                if leftBtn then
                    leftBtn.BackgroundColor3 = Color3.fromRGB(60, 120, 60)
                    if leftBtn:FindFirstChild("UIStroke") then
                        leftBtn.UIStroke.Color = Color3.fromRGB(100, 200, 100)
                    end
                end
            end            
            print("[Camlock] Enabled - Target: " .. target.Name)
        else
            print("[Camlock] No target found")
        end
    end
end
local function SwitchTarget()
    local newTarget = GetNextTarget()
    if newTarget then
        CamlockModule.CurrentTarget = newTarget        
        if CamlockModule.UI and CamlockModule.UI:FindFirstChild("MainFrame") then
            local rightBtn = CamlockModule.UI.MainFrame:FindFirstChild("RightBtn")
            if rightBtn then
                rightBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 120)
                if rightBtn:FindFirstChild("UIStroke") then
                    rightBtn.UIStroke.Color = Color3.fromRGB(100, 100, 200)
                end               
                task.spawn(function()
                    task.wait(0.15)
                    if rightBtn then
                        rightBtn.BackgroundColor3 = Color3.fromRGB(35,35,35)
                        if rightBtn:FindFirstChild("UIStroke") then
                            rightBtn.UIStroke.Color = Color3.fromRGB(120,120,120)
                        end
                    end
                end)
            end
        end        
        print("[Camlock] Switched to: " .. newTarget.Name)
    end
end
local function CreateUI()
    if CamlockModule.UI and CamlockModule.UI.Parent then
        CamlockModule.UI.Enabled = CamlockModule.UIVisible
        return CamlockModule.UI
    end
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "WaveUI"
    ScreenGui.ResetOnSpawn = false
    ScreenGui.Enabled = CamlockModule.UIVisible
    ScreenGui.Parent = player:WaitForChild("PlayerGui")
    local Main = Instance.new("Frame")
    Main.Name = "MainFrame"
    Main.Size = UDim2.new(0, 150, 0, 100)
    Main.Position = UDim2.new(0.5, -75, 0.45, 0)
    Main.BackgroundColor3 = Color3.fromRGB(20,20,20)
    Main.BackgroundTransparency = 0.15
    Main.BorderSizePixel = 0
    Main.Parent = ScreenGui
    Main.Active = true
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 14)
    corner.Parent = Main
    local stroke = Instance.new("UIStroke")
    stroke.Thickness = 2
    stroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    stroke.Color = Color3.fromRGB(255,255,255)
    stroke.Parent = Main
    local TopBtn = Instance.new("TextButton")
    TopBtn.Size = UDim2.new(0, 120, 0, 28)
    TopBtn.Position = UDim2.new(0.5, 0, 0, 10)
    TopBtn.AnchorPoint = Vector2.new(0.5, 0)
    TopBtn.Text = "   MAIN MODE"
    TopBtn.Font = Enum.Font.GothamBold
    TopBtn.TextSize = 12
    TopBtn.TextColor3 = Color3.fromRGB(240,240,240)
    TopBtn.BackgroundColor3 = Color3.fromRGB(35,35,35)
    TopBtn.AutoButtonColor = true
    TopBtn.Parent = Main
    Instance.new("UICorner", TopBtn).CornerRadius = UDim.new(0, 10)
    Instance.new("UIStroke", TopBtn).Color = Color3.fromRGB(130,130,130)
    local TopIcon = Instance.new("ImageLabel")
    TopIcon.Size = UDim2.new(0, 16, 0, 16)
    TopIcon.Position = UDim2.new(0, 8, 0.5, 0)
    TopIcon.AnchorPoint = Vector2.new(0, 0.5)
    TopIcon.BackgroundTransparency = 1
    TopIcon.Image = "rbxassetid://111450164466537"
    TopIcon.ImageColor3 = Color3.fromRGB(230,230,230)
    TopIcon.Parent = TopBtn
    local LeftBtn = Instance.new("TextButton")
    LeftBtn.Name = "LeftBtn"
    LeftBtn.Size = UDim2.new(0, 55, 0, 28)
    LeftBtn.Position = UDim2.new(0.25, 0, 1, -10)
    LeftBtn.AnchorPoint = Vector2.new(0.5, 1)
    LeftBtn.Text = "camlock"
    LeftBtn.Font = Enum.Font.GothamSemibold
    LeftBtn.TextSize = 11
    LeftBtn.TextColor3 = Color3.fromRGB(240,240,240)
    LeftBtn.BackgroundColor3 = Color3.fromRGB(35,35,35)
    LeftBtn.Parent = Main
    Instance.new("UICorner", LeftBtn).CornerRadius = UDim.new(0, 10)
    Instance.new("UIStroke", LeftBtn).Color = Color3.fromRGB(120,120,120)
    local RightBtn = Instance.new("TextButton")
    RightBtn.Name = "RightBtn"
    RightBtn.Size = UDim2.new(0, 55, 0, 28)
    RightBtn.Position = UDim2.new(0.75, 0, 1, -10)
    RightBtn.AnchorPoint = Vector2.new(0.5, 1)
    RightBtn.Text = "switch"
    RightBtn.Font = Enum.Font.GothamSemibold
    RightBtn.TextSize = 11
    RightBtn.TextColor3 = Color3.fromRGB(240,240,240)
    RightBtn.BackgroundColor3 = Color3.fromRGB(35,35,35)
    RightBtn.Parent = Main
    Instance.new("UICorner", RightBtn).CornerRadius = UDim.new(0, 10)
    Instance.new("UIStroke", RightBtn).Color = Color3.fromRGB(120,120,120)
    local dragging = false
    local dragStart
    local startPos
    UserInputService.InputBegan:Connect(function(input, gp)
        if gp then return end
        if input.UserInputType == Enum.UserInputType.MouseButton1
        or input.UserInputType == Enum.UserInputType.Touch then
            if input.Target and input.Target:IsDescendantOf(Main) then
                dragging = true
                dragStart = input.Position
                startPos = Main.Position
            end
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if not dragging then return end
        if input.UserInputType == Enum.UserInputType.MouseMovement
        or input.UserInputType == Enum.UserInputType.Touch then
            local delta = input.Position - dragStart
            Main.Position = UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
        end
    end)
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1
        or input.UserInputType == Enum.UserInputType.Touch then
            dragging = false
        end
    end)
    local t = 0
    local waveConnection = RunService.RenderStepped:Connect(function(dt)
        if not ScreenGui.Enabled then return end        
        t += dt * 2
        local wave = (math.sin(t) + 1) / 2
        local gray = math.floor(80 + wave * 175)
        stroke.Color = Color3.fromRGB(gray, gray, gray)
    end)
    TopBtn.MouseButton1Click:Connect(function()
        print("TOP BUTTON CLICKED - Main Mode")
    end)
    LeftBtn.MouseButton1Click:Connect(function()
        ToggleCamlock()
    end)
    RightBtn.MouseButton1Click:Connect(function()
        SwitchTarget()
    end)
    local keybindConnection = UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if not gameProcessed then
            if input.KeyCode == Enum.KeyCode.T then
                ToggleCamlock()
                if CamlockModule.Enabled then
                    LeftBtn.BackgroundColor3 = Color3.fromRGB(60, 120, 60)
                    LeftBtn.UIStroke.Color = Color3.fromRGB(100, 200, 100)
                else
                    LeftBtn.BackgroundColor3 = Color3.fromRGB(35,35,35)
                    LeftBtn.UIStroke.Color = Color3.fromRGB(120,120,120)
                end              
            elseif input.KeyCode == Enum.KeyCode.Y then
                SwitchTarget()
                RightBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 120)
                RightBtn.UIStroke.Color = Color3.fromRGB(100, 100, 200)                
                task.wait(0.1)                
                RightBtn.BackgroundColor3 = Color3.fromRGB(35,35,35)
                RightBtn.UIStroke.Color = Color3.fromRGB(120,120,120)
            end
        end
    end)
    CamlockModule.UI = ScreenGui
    CamlockModule.WaveConnection = waveConnection
    table.insert(CamlockModule.Connections, keybindConnection)
    table.insert(CamlockModule.Connections, waveConnection)    
    print("[WaveUI] Loaded successfully!")
    print("[Controls] T = Toggle Camlock | Y = Switch Target")   
    return ScreenGui
end
local function DestroyUI()
    if CamlockModule.WaveConnection then
        CamlockModule.WaveConnection:Disconnect()
        CamlockModule.WaveConnection = nil
    end    
    if CamlockModule.UI then
        CamlockModule.UI:Destroy()
        CamlockModule.UI = nil
    end
end
local function SetupKeybinds()
end
local function CleanupConnections()
    for _, conn in ipairs(CamlockModule.Connections) do
        if conn.Connected then
            conn:Disconnect()
        end
    end
    CamlockModule.Connections = {}
end
function CamlockModule:SetState(state)
    if state == self.Enabled then return end    
    if state then
        print("[CamlockModule] Enabling...")
        CreateUI()
        local camlockConnection = RunService.RenderStepped:Connect(function()
            UpdateCamlock()
        end)        
        table.insert(self.Connections, camlockConnection)        
        self.Enabled = true
        print("[CamlockModule] Enabled!")
        if WindUI then
            WindUI:Notify({
                Title = "Wave UI",
                Content = "Camlock đã bật! (T = Toggle, Y = Switch)",
                Duration = 5,
                Type = "success"
            })
        end        
    else
        print("[CamlockModule] Disabling...")
        CleanupConnections()
        self.Enabled = false
        self.CurrentTarget = nil
        if self.UI then
            self.UI.Enabled = false
        end        
        print("[CamlockModule] Disabled!")        
        if WindUI then
            WindUI:Notify({
                Title = "Wave UI",
                Content = "Camlock đã tắt!",
                Duration = 3,
                Type = "warning"
            })
        end
    end
end
function CamlockModule:Toggle(state)
    self:SetState(state)
end
function CamlockModule:Init()
    print("[CamlockModule] Initialized")
    print("Usage: CamlockModule:SetState(true/false)")
    print("CamlockModule:Toggle(state)")
    return self
end
CamlockModule:Init()

return CamlockModule
