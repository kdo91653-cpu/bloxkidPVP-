local CamlockModule = {}
CamlockModule.Enabled = false
CamlockModule.Connections = {}
CamlockModule.CurrentTarget = nil
CamlockModule.UIVisible = true
CamlockModule.Keybinds = {
    Toggle = Enum.KeyCode.T,
    Switch = Enum.KeyCode.Y
}
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer
local function GetClosestPlayer()
    local target = nil
    local maxDot = -1
    local camera = workspace.CurrentCamera
    local cameraPos = camera.CFrame.Position
    local cameraLook = camera.CFrame.LookVector
    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= player and p.Character then
            local hrp = p.Character:FindFirstChild("HumanoidRootPart")
            local hum = p.Character:FindFirstChildOfClass("Humanoid")
            if hrp and hum and hum.Health > 0 then
                local dir = (hrp.Position - cameraPos).Unit
                local dot = cameraLook:Dot(dir)
                if dot > 0 and dot > maxDot then
                    maxDot = dot
                    target = p
                end
            end
        end
    end
    return target
end
local function GetBodyPosition(character)
    if not character then return end
    local torso = character:FindFirstChild("UpperTorso") or character:FindFirstChild("Torso")
    local hrp = character:FindFirstChild("HumanoidRootPart")
    if torso then
        return torso.Position
    elseif hrp then
        return hrp.Position + Vector3.new(0,1.5,0)
    end
end
local function GetNextTarget()
    if not CamlockModule.CurrentTarget then
        return GetClosestPlayer()
    end
    local players = Players:GetPlayers()
    local index = table.find(players, CamlockModule.CurrentTarget) or 0
    for i = 1, #players do
        local nextIndex = (index + i - 1) % #players + 1
        local p = players[nextIndex]
        if p ~= player and p.Character then
            local hum = p.Character:FindFirstChildOfClass("Humanoid")
            if hum and hum.Health > 0 then
                return p
            end
        end
    end
end
local function UpdateCamlock()
    if not CamlockModule.Enabled or not CamlockModule.CurrentTarget then return end
    local char = CamlockModule.CurrentTarget.Character
    if not char then return end
    local hum = char:FindFirstChildOfClass("Humanoid")
    if not hum or hum.Health <= 0 then return end
    local pos = GetBodyPosition(char)
    if pos then
        local cam = workspace.CurrentCamera
        cam.CFrame = CFrame.new(cam.CFrame.Position, pos)
    end
end
local function ToggleCamlock()
    CamlockModule.Enabled = not CamlockModule.Enabled
    if not CamlockModule.Enabled then
        CamlockModule.CurrentTarget = nil
    else
        CamlockModule.CurrentTarget = GetClosestPlayer()
    end
end
local function SwitchTarget()
    CamlockModule.CurrentTarget = GetNextTarget()
end
local function CreateUI()
    if CamlockModule.UI then return CamlockModule.UI end
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "WaveUI"
    ScreenGui.ResetOnSpawn = false
    ScreenGui.Parent = player:WaitForChild("PlayerGui")
    local Main = Instance.new("Frame")
    Main.Name = "MainFrame"
    Main.Size = UDim2.new(0,150,0,100)
    Main.Position = UDim2.new(0.5,-75,0.45,0)
    Main.BackgroundColor3 = Color3.fromRGB(20,20,20)
    Main.BorderSizePixel = 0
    Main.Parent = ScreenGui
    Instance.new("UICorner", Main).CornerRadius = UDim.new(0,14)
    local stroke = Instance.new("UIStroke", Main)
    stroke.Thickness = 2
    local TopBtn = Instance.new("TextButton")
    TopBtn.Size = UDim2.new(0,120,0,28)
    TopBtn.Position = UDim2.new(0.5,0,0,10)
    TopBtn.AnchorPoint = Vector2.new(0.5,0)
    TopBtn.Text = "   MAIN MODE"
    TopBtn.Font = Enum.Font.GothamBold
    TopBtn.TextSize = 12
    TopBtn.BackgroundColor3 = Color3.fromRGB(35,35,35)
    TopBtn.Parent = Main
    Instance.new("UICorner", TopBtn).CornerRadius = UDim.new(0,10)
    local icon = Instance.new("ImageLabel")
    icon.Size = UDim2.new(0,16,0,16)
    icon.Position = UDim2.new(0,8,0.5,0)
    icon.AnchorPoint = Vector2.new(0,0.5)
    icon.BackgroundTransparency = 1
    icon.Image = "rbxassetid://111450164466537"
    icon.Parent = TopBtn
    local LeftBtn = Instance.new("TextButton")
    LeftBtn.Name = "LeftBtn"
    LeftBtn.Size = UDim2.new(0,55,0,28)
    LeftBtn.Position = UDim2.new(0.25,0,1,-10)
    LeftBtn.AnchorPoint = Vector2.new(0.5,1)
    LeftBtn.Text = "camlock"
    LeftBtn.Parent = Main
    Instance.new("UICorner", LeftBtn).CornerRadius = UDim.new(0,10)
    local RightBtn = Instance.new("TextButton")
    RightBtn.Name = "RightBtn"
    RightBtn.Size = UDim2.new(0,55,0,28)
    RightBtn.Position = UDim2.new(0.75,0,1,-10)
    RightBtn.AnchorPoint = Vector2.new(0.5,1)
    RightBtn.Text = "switch"
    RightBtn.Parent = Main
    Instance.new("UICorner", RightBtn).CornerRadius = UDim.new(0,10)
    local dragging = false
    local dragStart
    local startPos
    TopBtn.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1
        or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = UserInputService:GetMouseLocation()
            startPos = Main.Position
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if not dragging then return end
        if input.UserInputType == Enum.UserInputType.MouseMovement
        or input.UserInputType == Enum.UserInputType.Touch then
            local delta = UserInputService:GetMouseLocation() - dragStart
            Main.Position = UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
        end
    end)
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1
        or input.UserInputType == Enum.UserInputType.Touch then
            dragging = false
        end
    end)
    LeftBtn.MouseButton1Click:Connect(ToggleCamlock)
    RightBtn.MouseButton1Click:Connect(SwitchTarget)

    CamlockModule.UI = ScreenGui
    return ScreenGui
end
function CamlockModule:SetState(state)
    if state then
        CreateUI()
        table.insert(self.Connections,
            RunService.RenderStepped:Connect(UpdateCamlock)
        )
        self.Enabled = true
    else
        for _,c in ipairs(self.Connections) do
            if c.Connected then c:Disconnect() end
        end
        self.Connections = {}
        self.Enabled = false
    end
end
function CamlockModule:Init()
    return self
end

CamlockModule:Init()
return CamlockModule
